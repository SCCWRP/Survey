<!DOCTYPE html>
  <meta http-equiv="X-UA-Compatible" content="IE=Edge"/> 
    <head>
        <title>Wizard</title>
       	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
	<style type="text/css">
		#surveybuild { background-color: silver; }
	</style>
    	<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
   	<script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
	<script type="text/javascript">
	$(document).ready(function() {
	$("#one").on("click", ".finish", function(e) {
		// count number of build containers
		var buildCount = $('#surveybuild .build_container').length;
		// loop through each buildq, buildt and combine and send
		//! check that theres at least one record
		//data.object1 = object1;
		var data = {};
		for(i = 1; i <= buildCount; i++){
			 var record = {};
			 var buildQuestion = "#buildq"+i;
			 var buildType = "#buildt"+i;
			 var buildMenu = "#buildm"+i;
			 var buildOther = "#buildo"+i;
			 var buildAction = "#buildf"+i;
			 var buildPlaceHolder = "#buildph"+i;
			 var buildPlaceType = "#buildpt"+i;
			 data[i] = { "id": ""+i+"", "title": ""+$(buildQuestion)[0].innerHTML+"", "type" : ""+$(buildType)[0].innerHTML+"", "menu": ""+$(buildMenu)[0].innerHTML+"", "other": ""+$(buildOther)[0].innerHTML+"", "placeholder": ""+$(buildPlaceHolder)[0].innerHTML+"", "placetype": ""+$(buildPlaceType)[0].innerHTML+"", "action": ""+$(buildAction)[0].innerHTML+"" };
			 //data.record[i] = record[i];
			 //console.log($(buildQuestion)[0].innerHTML);
			 //console.log($(buildType)[0].innerHTML);
			 //{ "title": "First Question", "type" : "radio" }
			 //data.object+i = object+i;
		}
			//console.log(data);
			 submit(data);
			 //Object {errors: "success -> writing to zip file ", result: "Table tbl_1435761014 created successfully", url: "http://data.sccwrp.org/survey/export/survey_1435761014/survey_1435761014.zip"}

	});
	$("#select-qnumbers").bind( "change", function(e) {
		//test(e.target.value);
		build(e.target.value);
	});
	$('#questionaire').on('keyup', '.qtext', function(e) {
		var formButton = this.id;
		var lastChar = formButton.substr(formButton.length - 1);
		var formButton = this.id;
		var enteredText = $(this).val();
		var buildQuestion = "#buildq"+lastChar;
		$(buildQuestion).html(enteredText);
	});
	$('#questionaire').on('change', ".select-qmenu", function(e) {
		var formButton = this.id;
		var questionCount = $('#select-qnumbers').val();
		var lastChar = formButton.substr(formButton.length - 1);
		var buildType = "#buildt"+lastChar;
		var buildMenu = "#buildm"+lastChar;
		var buildOther = "#buildo"+lastChar;
		var buildPlaceHolder = "#buildph"+lastChar;
		var buildPlaceType = "#buildpt"+lastChar;
		var selectFmenu = "#select-fmenu" + lastChar;
		var selectFNmenu = "#select-fnmenu" + lastChar;
		//$(buildQuestion).append(" Form Type: "+e.target.value);
		// clear previous settings
		if($(buildType) != null || $(buildMenu) != null || $(buildOther) != null || $(buildPlaceHolder) != null || $(buildPlaceType) != null){
			$(buildType).text("");
			$(buildMenu).text("");
			$(buildOther).text("");
			$(buildPlaceHolder).text("");
			$(buildPlaceType).text("");
			$(selectFmenu).empty().append('<option>Flow Control</option><option>Default</option>')
			$(selectFNmenu).empty().append('<option>Go To</option>')
		}
		if(e.target.value == "text"){
			// clear placeholder
			clearValue(buildType,e.target.value);
			var phitems = prompt("Add placeholder");
			if(phitems != null){
				clearValue(buildPlaceHolder,phitems);
			}
			var ptitems = prompt("Add placetype (number,datetime-local)");
			if(ptitems != null){
				clearValue(buildPlaceType,ptitems);
			}
		}
		if(e.target.value == "radio"){
			clearValue(buildType,e.target.value);
			var items = prompt("Add radio menu items");
			if(items != null){
				//$(buildMenu).append(items);
				clearValue(buildMenu,items);
				var breakItems = items.split(",");
				for(var i = 0; i < breakItems.length; i++){
					//var actual_number = ( i + 1 );
					//$(".select-fmenu").append("<option value='"+breakItems[i]+"|"+i+"'>If user selects "+breakItems[i]+"</option>");
					//$(".select-fmenu").append("<option value='"+breakItems[i]+"'>If user selects "+breakItems[i]+"</option>");
					//var selectFmenu = "#select-fmenu" + lastChar;
					$(selectFmenu).append("<option value='"+breakItems[i]+"'>If user selects "+breakItems[i]+"</option>");
					//$(".select-fnmenu").append("<option value='"+actual_number+"'>go to question "+actual_number+"</option>");
				}
				for(var i = 0; i < questionCount; i++){
					var actual_number = ( i + 1 );
					//$(".select-fnmenu").append("<option value='"+actual_number+"'>go to question "+actual_number+"</option>");
					$(selectFNmenu).append("<option value='"+actual_number+"'>go to question "+actual_number+"</option>");
				}
			}
		}
		if(e.target.value == "multi"){
			clearValue(buildType,e.target.value);
			var items = prompt("Add multi menu items");
		        var item = items.split(",");	
			//console.log("items:"+items);
			if(items != null){
				// for looping through each will need later
				//$.each(item, function(key,value){
					//console.log(key + ": "+ value);
					//$(buildMenu).append(value);
				//});
				//$(buildMenu).append(items);
				clearValue(buildMenu,items);
			}
			if(items.indexOf("Other") > -1){
				clearValue(buildOther,"y");
				//$(buildOther).append("y");
			} else {
				clearValue(buildOther,"n");
				//$(buildOther).append("n");
			}
		}
		if(e.target.value == "photos"){
			clearValue(buildType,"radio");
			//$(buildType).append("radio");
			//var items = prompt("Add multi menu items");
			//if(items != null){
				//$(buildMenu).append(items);
			//}
			clearValue(buildMenu,"Camera,Library");
			clearHolderType(buildPlaceHolder,buildPlaceType);
			//$(buildMenu).append("Camera,Library");
		}
		if(e.target.value == "select"){
			clearValue(buildType,e.target.value);
			//$(buildType).append(e.target.value);
			var items = prompt("Add select menu items");
			if(items != null){
				clearValue(buildMenu,items);
				//$(buildMenu).append(items);
			}
			if(items.indexOf("Other") > -1){
				clearValue(buildOther,"y");
				//$(buildOther).append("y");
			} else {
				clearValue(buildOther,"n");
				//$(buildOther).append("n");
			}
		}
		//$(buildQuestion).append(" Form Type: "+e.target.value);
	});
	//$('#questionaire').on('change', ".select-fmenu", function(e) {
	$('#questionaire').on('change', ".select-fnmenu", function(e) {
		var formButton = this.id;
		var lastChar = formButton.substr(formButton.length - 1);
		var currentAction = "#select-fmenu" + lastChar;
		var currentActionNumber = e.target.value;
		var currentActionCombine = $(currentAction).val() + "|" + currentActionNumber;
		var buildAction = "#buildf"+lastChar;
		$(buildAction).append(currentActionCombine);
	});
	// add individual survey items by clicking add
	/*
	$("#questionaire").on("click", ".submit", function(e) {
		var formButton = this.id;
		var lastChar = formButton.substr(formButton.length - 1);
		var formQuestion = "#qtext"+lastChar;
		var buildQuestion = "#build"+lastChar;
		newQuestion = $(formQuestion).val();
		//$(buildQuestion).append(newQuestion);
		$("#surveybuild").append(newQuestion);
	});
	*/
	function clearHolderType(ph,pt){
	       	$(ph).text("");
	       	$(pt).text("");
	}
	function clearValue(sdiv,stext){
		if($(sdiv).text()){
	        	$(sdiv).text("");
		}
		$(sdiv).append(stext);
	}
	function submit(data){
		console.log(data);
		//console.log(data);
		/*
		var data = {};
		var object1 = { "title": "First Question", "type" : "radio" };
		var object2 = { "title": "Second Question", "type" : "radio" };
		data.object1 = object1;
		data.object2 = object2;
		*/
		//nq = JSON.stringify({ "title": "First Question", "type" : "radio" });
		$.ajax({
			type: "GET",
			url: "http://data.sccwrp.org/survey/build.php",
			//data: {"title": "my test"},
			data: data,
			dataType: "jsonp",
			error: function(x,t,m){
				console.log(x);
			},
			success: function(data){
				console.log(data);
				$("#client_html").attr("href", data.url);
				$("#client_zip").attr("href", data.zip);
				$.mobile.changePage("#two");
			}
	  	});
	}

	});
	function build(nq){
		for(i = 0; i < nq; i++){
			var rq = (i + 1);
			var newContent = 'Question'+rq+': \
					 <input id="qid'+rq+'" type="text" class="qtext"></input> \
					 <select id="select-qmenu'+rq+'" class="select-qmenu"> \
					 	<option>Select One</option> \
					 	<option>text</option> \
					 	<option>photos</option> \
					 	<option>radio</option> \
					 	<option>select</option> \
					 	<option>multi</option> \
					 </select> \
					 <select id="select-fmenu'+rq+'" class="select-fmenu"> \
					 	<option>Flow Control</option> \
					 	<option>Default</option> \
					 </select> \
					 <select id="select-fnmenu'+rq+'" class="select-fnmenu"> \
					 	<option>Go To</option> \
					 </select> \
					 <br> \
					';
			$("#questionaire").append(newContent);
			$("#surveybuild").append('<div id="build'+rq+'" class="build_container">Screen'+rq+'<div id="buildq'+rq+'"></div><div id="buildt'+rq+'"></div><div id="buildm'+rq+'"></div><div id="buildo'+rq+'"></div><div id="buildf'+rq+'"></div><div id="buildph'+rq+'"></div><div id="buildpt'+rq+'"></div></div>');
					 //<input id="submit'+rq+'" type="submit" value="Add" class="submit">';
		}
	}
	</script>
  </head>
  <body>
	<div id="one" data-role="page">
	<h3>Mobile Survey Wizard</h3>
	<h2>Disabled build.php and index.php</h2>
	<div data-role="fieldcontain">
		<label for="select-qnumbers" class="select">How many questions does your survey contain?</label>
		<select name="select-qnumbers" id="select-qnumbers">
			<option>Select One</option>
			<option value="1">1</option>
			<option value="2">2</option>
			<option value="3">3</option>
			<option value="4">4</option>
			<option value="5">5</option>
			<option value="6">6</option>
			<option value="7">7</option>
			<option value="8">8</option>
			<option value="9">9</option>
			<option value="10">10</option>
			<option value="11">11</option>
			<option value="12">12</option>
			<option value="13">13</option>
			<option value="14">14</option>
			<option value="15">15</option>
			<option value="16">16</option>
			<option value="17">17</option>
			<option value="18">18</option>
			<option value="19">19</option>
			<option value="20">20</option>
		</select>
	</div>
	<div id="questionaire"></div>
	<div id="surveybuild"></div>
	<button id="finish" class="finish">Finished</button>
	</div>
	<div id="two" data-role="page">
	<h3>Mobile Survey Client</h3>
	<div data-role="fieldcontain">
		<a id="client_html" href="#">Client Web Page [html]</a> - 
		<a id="client_zip" href="">Client Phonegap Package [zip]</a> - 
		<a id="client_csv" href="#">Client CSV Export [csv]</a>
		<div id="surveyresult"></div>
	</div>
  </body>
</html>
